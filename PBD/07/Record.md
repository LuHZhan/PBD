# 3D 仿真向量数学直观指南 (Intuitive 3d Vector Math for Simulation)

**讲师:** Matthias Müller (Ten Minute Physics)  
**核心目标:** 介绍编写 3D 仿真代码所需的数学核心概念，不仅包含定义，更侧重于物理直观理解。

---

## 1. 坐标系 (Coordinate Systems)

### 1.1 数学与图形学的差异
*   **右手坐标系 (Right-handed System):**
    *   拇指 = X轴，食指 = Y轴，中指 = Z轴。
*   **数学标准:** Z轴向上 (Z-up)，X和Y在地面。
*   **图形学标准 (Graphics):** **Y轴向上 (Y-up)**。
    *   *原因:* 屏幕本身是2D坐标系（X向右，Y向上），深度方向即为Z轴（指向屏幕外/摄像机）。这也解释了为什么深度缓冲被称为 Z-buffer。
    *   本教程及常见仿真使用 **图形学标准 (Y-up)**。

### 1.2 向量表示
*   **定义:** 3个分量/坐标的组合。
*   **记法:**
    *   列向量 (Column form)：用方括号括起来的垂直排列数字。
    *   符号：粗体小写字母 (如 $\mathbf{v}$)。
*   **两种用途:**
    1.  **位置 (Location):** 空间中的点 (如粒子位置 $\mathbf{p}$)。
    2.  **箭头 (Arrow):** 具有方向和大小的量 (如速度 $\mathbf{v}$)。

---

## 2. 基础向量运算 (Basic Operations)

### 2.1 加法 (Addition)
*   **用途:** 时间积分 (Move forward in time)。
*   **公式:** $\mathbf{p}_{new} = \mathbf{p} + \mathbf{a}$ (对应分量相加)。

### 2.2 缩放 (Scaling)
*   **用途:** 从速度计算位置更新量。
*   **操作:** 向量 $\times$ 标量 (如 $\Delta t \mathbf{v}$)。
*   **特性:** 改变长度，**方向不变**。

### 2.3 减法 (Subtraction)
*   **用途:** 计算两点间的向量。
*   **公式:** 从 A 指向 B 的向量 = $\mathbf{b} - \mathbf{a}$。
    *   *注意:* 是 **目标 - 起点** (Not A-B)。

### 2.4 长度 (Length)
*   **公式:** $|\mathbf{v}| = \sqrt{v_x^2 + v_y^2 + v_z^2}$ (毕达哥拉斯定理/勾股定理)。

### 2.5 归一化 (Normalization)
*   **单位向量 (Unit Vector/Normal):** 长度为 1 的向量，通常用 $\mathbf{n}$ 表示。
*   **计算:** $\mathbf{n} = \mathbf{v} / |\mathbf{v}|$ (向量除以其长度)。

---

## 3. 两个核心运算 (Dot & Cross Product)

### 3.1 点积 (Dot Product) $\mathbf{a} \cdot \mathbf{b}$
*   **定义:** $a_x b_x + a_y b_y + a_z b_z$。
*   **结果:** **标量 (Scalar)** (这也是它叫标量积的原因)。
*   **核心用途:**
    1.  **投影长度:** 计算向量 $\mathbf{v}$ 在单位向量 $\mathbf{n}$ 方向上的长度 ($len = \mathbf{v} \cdot \mathbf{n}$)。
    <div align ="center">
        <img src="GenerlaVectorComponents.png" width="75%">
    </div>

    ```
    2. [几何定义] 投影长度 = |v| * cos(θ)                     
    3. [点积定义] v·n = |v| * |n| * cos(θ)                   
    4. [代入消去] 投影长度 = (v·n) / |n|                    
    5. [归一化] 单位向量 = n / |n|                         
    6. [最终公式] 投影向量 = 投影长度 * 单位向量
                = (v·n) / |n| * n / |n|
                = (v·n) / |n|² * n                 
    ```

    7.  **垂直检测:** 如果 $\mathbf{a} \cdot \mathbf{b} = 0$，则两向量互相**垂直**。
    8.  **分解:** 将向量分解为切向分量和法向分量（用于处理摩擦力和恢复力）。

### 3.2 叉积 (Cross Product) $\mathbf{a} \times \mathbf{b}$
*   **结果:** **向量 (Vector)**。
*   **几何意义:** 生成一个同时垂直于 $\mathbf{a}$ 和 $\mathbf{b}$ 的新向量。遵循右手定则。
*   **核心用途:**
    1.  **三角形法线:** $(\mathbf{p}_2 - \mathbf{p}_1) \times (\mathbf{p}_3 - \mathbf{p}_1)$。
   
        #### 逆时针约定（CCW - Counter-Clockwise）
        这是图形学中最常见的约定：
        - **从法向量方向看**，顶点按逆时针排列
        - **右手定则**：手指沿 p1→p2→p3 弯曲，拇指指向法向
        - **引擎默认**：UE和Unity都使用CCW作为"正面"

    <div align ="center">
        <img src="OrientationOfSurfaceMeshes.png" width="75%">
    </div>




    1.  **三角形面积:** Area = $\frac{1}{2} |\mathbf{a} \times \mathbf{b}|$ (叉积结果的长度是平行四边形面积)。
       <div align ="center">
        <img src="LengthOfCrossProduct.png" width="75%">
    </div> 

    2.  **四面体体积:** Volume = $\frac{1}{6} (\mathbf{a} \times \mathbf{b}) \cdot \mathbf{c}$ (混合积)。
    <div align ="center">
        <img src="TetrahedralVolume.png" width="75%">
    </div> 


---

## 4. 矩阵与变换 (Matrices & Transformations)

### 4.1 $3\times3$ 矩阵
*   **记法:** 大写字母 (如 $A$)。
*   **直观理解 (关键点):**
    *   矩阵乘法 $\mathbf{Ax}$ 可以理解为：矩阵的**列向量 (Columns)** 是变换后的**新坐标轴**。
    *   $\mathbf{Ax} = x_1 \mathbf{a}_1 + x_2 \mathbf{a}_2 + x_3 \mathbf{a}_3$。
    *   如果列向量长度 $>1$，则拉伸；$<1$，则压缩。

### 4.2 仿射变换 (Affine Transformation)
*   **公式:** $\mathbf{v}' = A\mathbf{v} + \mathbf{b}$
    *   $A$: 线性变换 (旋转、缩放、切变)。
    *   $\mathbf{b}$: 平移 (Translation/Offset)，即新坐标系的原点。

### 4.3 行列式 (Determinant)
*   **物理意义:** 体积缩放因子。
    *   $\det(A) = 1$: 体积守恒 (如纯旋转)。
    *   $\det(A) = 0$: 体积塌缩 (所有轴共面，变换不可逆)。
    *   几何上，它是由矩阵列向量构成的平行六面体的体积。

### 4.4 矩阵组合与逆矩阵
*   **组合:** $C = BA$ (先应用 A，再应用 B)。
*   **逆矩阵 ($A^{-1}$):** 逆向变换，回到原点。$\mathbf{x} = A^{-1}(A\mathbf{x})$。
*   **应用 - 四面体蒙皮 (Tetrahedral Skinning):**

    <div align ="center">
        <img src="TetrahedralSkinning.png" width="75%">
    </div> 
好的，这张图非常精彩地解释了三维计算机图形学中一项核心技术——四面体蒙皮的原理。这是一种用于角色动画、物理模拟等领域的模型变形技术。

下面我将分步详解这个转换过程。

### 核心目标

我们有一个物体（比如角色模型的顶点），它嵌入在一个四面体（作为“骨骼”或“控制体”）内部。当这个控制四面体发生任意变形（旋转、缩放、平移、拉伸）时，我们希望嵌入其中的点 x 能自动、平滑地变换到新位置 x'，仿佛被四面体“带着走”一样。这个过程就是“蒙皮”。

---

### 转换的两个阶段

图中的公式 `x' = P Q⁻¹ x + (p - P Q⁻¹ q)` 完美地描述了这个过程。我们可以将其理解为两个连续的步骤：

#### 第1步：将点 x 从世界坐标映射到四面体的局部坐标（`Q⁻¹ x`）

1.  构建局部坐标系（矩阵 Q）：
    ◦ 看图左上角的初始四面体。我们以其中一个顶点（例如 q₀）为原点，构建一个局部坐标系。这个坐标系的三个轴由从 q₀ 出发到另外三个顶点的向量定义：q₁ - q₀, q₂ - q₀, q₃ - q₀。

    ◦ 矩阵 Q 就是由这三个向量作为列向量构成的 3x3 矩阵。Q 定义了初始四面体的“姿态”和“形状”。


2.  坐标变换（求逆）：
    ◦ 任何在四面体内部的点 x，都可以用这个局部坐标来表示，即 x = Q b + q₀，其中 b 是 x 在局部坐标系下的坐标。

    ◦ 为了得到 b，我们进行逆变换：b = Q⁻¹ (x - q₀)。公式中的 `Q⁻¹ x` 部分其实是简化写法，其完整含义就是计算点 x 相对于四面体局部坐标系的“权重”或“相对位置” b。

    ◦ 这一步的精髓在于，无论四面体如何变形，点 x 在它内部的这个“相对位置” `b` 是应该保持不变的。


#### 第2步：将点的局部坐标映射到变形后的世界坐标（`P b + p₀`）

1.  构建变形后的坐标系（矩阵 P）：
    ◦ 看图右上角变形后的四面体。同样，我们以新四面体的对应顶点 p₀ 为原点，用新的边向量 p₁ - p₀, p₂ - p₀, p₃ - p₀ 构建新的矩阵 P。P 定义了变形后四面体的新“姿态”和“形状”。


2.  应用变换：
    ◦ 现在，我们将第一步中计算得到的、保持不变的局部坐标 b，应用到这个新的坐标系 P 上。即 x' = P b + p₀。

    ◦ 因为 b = Q⁻¹ (x - q₀)，代入后得到：

      x' = P [Q⁻¹ (x - q₀)] + p₀
      x' = P Q⁻¹ x - P Q⁻¹ q₀ + p₀
      x' = P Q⁻¹ x + (p₀ - P Q⁻¹ q₀)

这正是图中最终的公式：x' = P Q⁻¹ x + (p - P Q⁻¹ q)。这里的 p 和 q 就对应我们例子中的 p₀ 和 q₀。


总而言之，四面体蒙皮的转换是一个巧妙的仿射变换。它通过“世界坐标 -> 局部坐标 -> 新的世界坐标”这两步映射，确保了点与其嵌入的四面体之间的相对关系在变形过程中保持不变，从而实现逼真、平滑的几何体变形。这张图及其公式是该技术的核心数学描述。

*  通过逆矩阵将世界坐标点映射回四面体的局部坐标（重心坐标概念），用于随四面体变形驱动顶点运动。
       公式: $\mathbf{x}' = P Q^{-1} \mathbf{x} + (\mathbf{p} - P Q^{-1} \mathbf{q})$。

---

## 5. 刚体变换 (Rigid Transforms)

### 5.1 定义
*   仅包含**平移**和**旋转**。
*   没有缩放或切变。

### 5.2 特性
*   旋转矩阵的列向量：
    1.  长度为 1 (单位向量)。
    2.  互相垂直 (点积为 0)。
*   **重要性质:** 对于旋转矩阵 $R$，其逆矩阵等于其转置矩阵。
    *   **$R^{-1} = R^T$**
    *   *意义:* 计算转置比计算逆矩阵快得多，这就是刚体仿真高效的原因。

### 5.3 转置 (Transpose) $A^T$
*   行变列，列变行。
*   **无点点积 (Dot-less Dot Product):** $\mathbf{a} \cdot \mathbf{b} = \mathbf{a}^T \mathbf{b}$ (矩阵乘法形式)。
*   $\mathbf{a}^T \mathbf{a} = |\mathbf{a}|^2$ (长度的平方)。

---

## 6. 四元数 (Quaternions)

### 6.1 为什么要用四元数？
*   矩阵存储 9 个值，对于仅有 3 个自由度的旋转来说太浪费。
*   轴角表示法 (Axis-Angle) 需要计算三角函数 ($\sin, \cos$)，计算成本高。
*   四元数只需 4 个值，计算旋转更高效。

### 6.2 定义
*   由一个向量部分和一个标量部分组成：$\mathbf{q} = [x, y, z, w]$。
*   基于轴角 $(\mathbf{n}, \alpha)$ 的构造 (视频中的直观形式):
    *   向量部分: $\sin(\alpha) \cdot \mathbf{n}$ (注意：标准数学定义中通常是 $\alpha/2$，视频为了直观可能简化了描述，重点在于它编码了轴和正弦值)。
    *   标量部分: $\cos(\alpha)$。

### 6.3 运算
*   **旋转向量:** $\mathbf{v}' = \text{rot}(\mathbf{q}, \mathbf{v})$。
*   **组合旋转:** 四元数乘法 $\mathbf{q} = \mathbf{q}_1 \mathbf{q}_2$。
*   **逆旋转:** 非常简单，只需反转向量部分的符号 (对于单位四元数)。
    *   $\mathbf{q}^{-1} = [-q_x, -q_y, -q_z, q_w]$。